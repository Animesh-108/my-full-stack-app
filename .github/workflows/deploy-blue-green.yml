name: Deploy App (Blue-Green EKS)

on:
  push:
    branches:
      - main

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      service: ${{ steps.detect.outputs.service }}
    steps:
      - uses: actions/checkout@v4

      - name: Detect which service changed
        id: detect
        run: |
          echo "üîç Checking which service changed..."

          # Handle first commit or shallow clone
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          else
            echo "üÜï First commit or shallow clone detected. Comparing all files."
            CHANGED_FILES=$(git ls-tree -r --name-only HEAD)
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          if echo "$CHANGED_FILES" | grep -q "^frontend/"; then
            echo "‚úÖ Detected frontend changes"
            echo "service=frontend" >> $GITHUB_OUTPUT
          elif echo "$CHANGED_FILES" | grep -q "^backend/"; then
            echo "‚úÖ Detected backend changes"
            echo "service=backend" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è No service changes detected"
            echo "service=none" >> $GITHUB_OUTPUT
          fi

  deploy:
    needs: detect
    if: needs.detect.outputs.service != 'none'
    runs-on: ubuntu-latest
    env:
      SERVICE: ${{ needs.detect.outputs.service }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Ensure ECR repository exists
        run: |
          if [ "$SERVICE" = "frontend" ]; then
            REPO_NAME="frontend"
          else
            REPO_NAME="backend"
          fi

          aws ecr describe-repositories --repository-names $REPO_NAME --region ${{ secrets.AWS_REGION }} || \
          aws ecr create-repository --repository-name $REPO_NAME --region ${{ secrets.AWS_REGION }}

      - name: Build Docker image
        run: |
          if [ "$SERVICE" = "frontend" ]; then
            IMAGE=$(echo "${{ secrets.ECR_REPO_FRONTEND }}" | tr -d '\n\r')
            cd frontend
          else
            IMAGE=$(echo "${{ secrets.ECR_REPO_BACKEND }}" | tr -d '\n\r')
            cd backend
          fi

          echo "üõ† Building Docker image for $SERVICE..."
          docker build -t "${IMAGE}:green" .
          docker tag "${IMAGE}:green" "${IMAGE}:${{ github.sha }}"

      - name: Push Docker image to ECR
        run: |
          if [ "$SERVICE" = "frontend" ]; then
            IMAGE=$(echo "${{ secrets.ECR_REPO_FRONTEND }}" | tr -d '\n\r')
          else
            IMAGE=$(echo "${{ secrets.ECR_REPO_BACKEND }}" | tr -d '\n\r')
          fi

          echo "üì§ Pushing Docker image for $SERVICE..."
          docker push "${IMAGE}:green"
          docker push "${IMAGE}:${{ github.sha }}"

      - name: Update kubeconfig
        run: |
          echo "üîß Updating kubeconfig for blue-green-cluster..."
          aws eks update-kubeconfig --name blue-green-cluster --region "${{ secrets.AWS_REGION }}"

      - name: Deploy to Kubernetes (Green)
        run: |
          if [ "$SERVICE" = "frontend" ]; then
            IMAGE=$(echo "${{ secrets.ECR_REPO_FRONTEND }}" | tr -d '\n\r')
            MANIFEST="k8s/frontend-green.yaml"
          else
            IMAGE=$(echo "${{ secrets.ECR_REPO_BACKEND }}" | tr -d '\n\r')
            MANIFEST="k8s/backend-green.yaml"
          fi

          echo "üöÄ Deploying ${SERVICE}-green with image ${IMAGE}:green"
          kubectl apply -f $MANIFEST
          kubectl set image deployment/${SERVICE}-green ${SERVICE}=${IMAGE}:${{ github.sha }}
          kubectl rollout status deployment/${SERVICE}-green --timeout=120s

      - name: Verify Green Deployment Health
        run: |
          echo "üîç Verifying Green deployment health..."
          kubectl rollout status deployment/${SERVICE}-green --timeout=60s || {
            echo "‚ùå Green deployment failed! Rolling back to Blue..."
            kubectl patch svc ${SERVICE}-service -p "{\"spec\":{\"selector\":{\"app\":\"${SERVICE}\",\"version\":\"blue\"}}}"
            exit 1
          }

      - name: Switch Traffic (Blue ‚Üí Green)
        if: success()
        run: |
          echo "üîÅ Switching traffic to ${SERVICE}-green..."
          kubectl patch svc ${SERVICE}-service -p "{\"spec\":{\"selector\":{\"app\":\"${SERVICE}\",\"version\":\"green\"}}}"
          kubectl get svc ${SERVICE}-service

      - name: Refresh Blue Deployment
        if: success()
        run: |
          echo "‚ôªÔ∏è Refreshing Blue deployment for next cycle..."
          if [ "$SERVICE" = "frontend" ]; then
            IMAGE=$(echo "${{ secrets.ECR_REPO_FRONTEND }}" | tr -d '\n\r')
          else
            IMAGE=$(echo "${{ secrets.ECR_REPO_BACKEND }}" | tr -d '\n\r')
          fi
          kubectl set image deployment/${SERVICE}-blue ${SERVICE}=${IMAGE}:${{ github.sha }}
